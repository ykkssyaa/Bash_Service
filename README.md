# Сервис обработки и запуска bash-скриптов

[Ссылка на задание](https://gist.github.com/ixpectus/aec3f753a3209fbd8100c1b2c42d5756)

## Описание задачи
Необходимо разработать приложение, которое будет предоставлять REST API для запуска команд. 
Команда представляет собой bash-скрипт. Приложение должно позволять параллельно запускать произвольное количество команд.

## Запуск
### Локальный запуск
1. Клонирование репозитория
2. `make docker.run.db` - запуск postgres
3. `make docker.run.migrate` - запуск миграций 
(либо использовать `make migrate.up`, если утилита [golang-migrate](https://github.com/golang-migrate/migrate) установлена локально) 
4. `make local.run` - локальный запуск сервера

### Запуск в Docker
1. Клонирование репозитория
2. `make docker.run`

В данном случае миграции для базы данных накатятся сами.

### Остановка работы Docker
Для остановки и удаления контейнеров используйте команду `make docker.down`

### Описание системы 
Во время работы использовалась система **Ubuntu 22.04.4 LTS** и golang версии **1.21.3**.
В качестве базы данных используется **PostgreSQL**.

## API
Всё API описано в спецификации OpenAPI(Swagger) [в этом файле](./api/api.yaml)

Для удобства тестирования сервиса предлагается воспользоваться [коллекцией Postman](https://www.postman.com/joint-operations-operator-99149269/workspace/bash-service/collection/28284200-9d901b5a-0f89-4cf7-84ca-173c97675e38?action=share&creator=28284200&active-environment=28284200-149f41bf-ad66-405b-96e8-291bd27ca86c).
В коллекции описаны все endpoint'ы и есть возможность удобно обратиться к сервису. 
Для подключения переменных среды необходимо подключить environment Bash. 

## Реализованный функционал

Реализованые endpoint'ы:
1. Создание и запуск команды
2. Получение состояния команды по id
3. Получение всех команд с пагинацией (offset, limit)
4. Остановка команды по id

Состояние команды задается её статусом(работает, остановлена, выполнена с ошибкой, успешное выполнение), 
выводом в консоль и в id системе. При создании процесса выполнения команды создается контекст, 
который передается в обработчик, а функция отмены контекста сохраняется в key-value хранилище, к которому можно обратиться
для отмены контекста и, следовательно, остановки процесса выполнения команды. 
Контекст имеет время жизни - 5 минут(задается через константу CtxTimeout в [consts](./internal/consts/consts.go))

При создании команды пользователь получает id команды, с помощью которого он может следить за её состоянием. 
Сервис поддерживает обработку долгих в выполнении комманд. Состояние команды проверяется и обновляется каждую секунду
(задается через константу ReadOutputTime в [consts](./internal/consts/consts.go)). Во время выполнения команды, её состояние
хранится в in-memory кеше,а в базу данных попадает только после окончания работы процесса.

## Примеры скриптов

```json
{
  "script": "for ((i=1; i<=100; i++))\ndo\n   echo $i\n   sleep 2\ndone"
}
```

```json
{
  "script": "ls -l -1 -S"
}
```

```json
{
  "script": "cat makefile | grep \"docker\""
}
```


## Принятые в ходе разработки решения

